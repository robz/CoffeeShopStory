<html>
<p id="story"><a id="John" href="#"></a><a id="Julia" href="#"></a><a id="Angela" href="#"></a></p>
<br/>
<strong><a id="next" href="#"></a></strong>

<script>
(function main() {
    var timeCount = -1,
        defaultCharacter = "John",
        restartText = "<strong><em>The scene fades, the curtain falls, the credits roll... and now we begin again.</em></strong>",
        curCharacter = defaultCharacter,

        characters = {
            John: {
                name: "John",
                alias: "some guy",
                known: true,
                stories: [
                    "After holding the door open for #Angela, John walks into the coffee shop. <br/><br/>\
                    He immediately takes note of #Julia reading a book in a comfortable chair near the far wall.",
                   
                    "Pretending to ignore her, John gets in line, takes out his phone, and checks his texts.",

                    "John has received one text from #Steven, sent about a minute ago: <em>running late. be there in 5</em>.<br/><br/>\
                    He hears someone ordering a chai latte with a triple shot of expresso. \
                    He steps forward in line, looking up briefly to see #Sara walking away from the counter.<br/><br/>\
                    Watching the far wall out the corner of his eye, he replies to the text.",

                    '"Soy mocha for %Angela!" shouts #Monica.',
                    
                    restartText
                ]
            },

            Julia: {
                name: "Julia",
                alias: "the girl",
                known: false,
                stories: [
                    "wat",
                    
                    "Julia looks up from her book, noticing #John walk into the coffee shop. \
                    She recongizes him, but can't remember his name, nor remember where she met him. Well, this is awkward. \
                    She goes back to her book, pretending to ignore him.",
                    
                    "TODO: Julia 2",
                    
                    '"Soy mocha for %Angela!" shouts #Monica.',
                    
                    restartText
                ]
            },

            Angela: {
                name: "Angela",
                alias: "an elderly woman",
                known: false,
                stories: [
                    "wat",
                    
                    "Angela smiles at the young man who held the door for her, but he doesn't notice, \
                    being too distracted by some pretty girl in the back of the cafe. \
                    Angela rolls her eyes and walks to the outdoor seating area.<br/><br/>\
                    She walks pass a table where old man Henry and his grandson are playing chess. Henry winks at her, sucking at a cigar. She shudders and thinks, <em>how dreadful!<em/>",
                    
                    "Pinching her nose to avoid breathing in the smoke, Angela walks to her table under a large umbrella and sits down. \
                    She opens a newspaper to the 'I-saw-you' section, where anonymous people send in short descriptions of strangers that they see, \
                    but don't properly meet. Angela absolutely adores this section. \
                    Something about reading people's private thoughts makes the world seem just a little bit more romantic.",
                    
                    "Angela hear one of the baristas call her name from inside the cafe. <em>That was fast!</em> she thinks.\
                    But just before rising she sees a particularly interesting I-saw-you post, and pauses to read it:<br><br/>\
                    ...TODO...%Sara...TODO...",
                    
                    restartText
                ]
            },
            
            Steven: {
                name: "Steven",
                alias: "a friend",
                known: false,
                stories: [
                    "wat",
                    
                    "wat",
                    
                    "wat",
                    
                    "Steven is sitting lethargically on the couch in his apartment. His phone vibrate, but he doesn't notice it. \
                    His eyes droop. He should go meet John. He should get up and drive to that coffee shop. He should...<br/><br/>\
                    Steven suddenly remembers how comfortable the cushions on his couch are. He leans against them for a moment, and then immediately falls back asleep.",

                    restartText
                ]
            },
            
            Sara: {
                name: "Sara",
                alias: "a very sleep-deprived college student",
                known: false,
                stories: [
                    "wat",
                    
                    "wat",
                    
                    "wat",
                    
                    "Sara walks back to her table noticing every minute detail around her, thinking of each as a novel, beautiful thing. \
                    As she sits down, she wonders what she'll be doing in 10 years, and then considers the state of the human race for a brief moment. \
                    She smiles for no reason at all, and then rests her head on the stack of textbooks crowding her table. \
                    She'll just close her eyes for a second, just until her chai latte is ready...<br/><br/>\
                    She falls asleep and begins to dream about %Steven.",
                    
                    restartText
                ]
            },
            
            Monica: {
                name: "Monica",
                alias: "one of the baristas",
                known: false,
                stories: [
                    "wat",
                    
                    "wat",
                    
                    "wat",
                    
                    "wat",
                    
                    restartText
                ]
            },
        },

        totalTimeSteps = characters[defaultCharacter].stories.length,

        reset = function () {
            timeCount = -1;
            curCharacter = defaultCharacter;
        },
        
        replaceHashtagsWithLinks = function (story) {
            return story.replace(/\#[A-Za-z]+/g, function (match) {
                var refname = match.substring(1, match.length);
                
                if (characters[refname]) {
                    if (characters[refname].known) {
                        return '<a id="' + refname + '" href="#">' + characters[refname].name + '</a>';
                    } else {
                        return characters[refname].alias;
                    }
                } else {
                    return match;   
                }
            });
        },
        
        noteAndReplaceDiscoveries = function (story) {
            return story.replace(/%[A-Za-z]+/g, function (match) {
                var refname = match.substring(1, match.length);
                
                if (characters[refname]) {
                    characters[refname].known = true;
                    return characters[refname].name;
                } else {
                    return match;   
                }
            });
        }
        
        setLink = function (name) {
            document.getElementById(name).onclick = function () {
                curCharacter = name;
                step();
            };
        },

        step = function () {
            if (timeCount == totalTimeSteps - 1) {
                reset();
            }
            
            timeCount += 1;
            
            document.getElementById("next").innerHTML = (timeCount == totalTimeSteps - 1) ? "RESTART" : "CONTINUE";
            
            var story = characters[curCharacter].stories[timeCount];
            
            document.getElementById("story").innerHTML = replaceHashtagsWithLinks(noteAndReplaceDiscoveries(story));
            
            // reset link callbacks
            for (var name in characters) {
                if (characters.hasOwnProperty(name)) {
                    try {
                        setLink(name);
                    } catch (e) {}
                }
            }
        };
    
    document.getElementById("next").onclick = function () {
        step();
    };
    
    reset();
    step();
})();
</script>
</html>